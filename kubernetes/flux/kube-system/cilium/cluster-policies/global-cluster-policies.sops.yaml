apiVersion: cilium.io/v2
kind: CiliumClusterwideNetworkPolicy
metadata:
    name: host-fw-control-plane
    namespace: kube-system
spec:
    description: control-plane specific access rules.
    nodeSelector:
        matchLabels:
            node-role.kubernetes.io/control-plane: ""
    ingress:
        # Allow access to kube api from anywhere.
        - fromEntities:
            - world
            - cluster
          toPorts:
            - ports:
                - port: "6443"
                  protocol: TCP
        # Allow access to talos from anywhere.
        # https://www.talos.dev/v1.4/learn-more/talos-network-connectivity/
        - fromEntities:
            - cluster
        - fromCIDR:
            - ENC[AES256_GCM,data:2ATeXFuRFTuxtcN1LGRClt8=,iv:jKUh4E+RSKhgV1aUkXqEUVd3sJYItCZGGmPhk3K2Ebc=,tag:uAmXjCTdqeZyLLZbuCNeSQ==,type:str]
          toPorts:
            - ports:
                - port: "50000"
                  protocol: TCP
                - port: "50001"
                  protocol: TCP
        # Allow kube-proxy-replacement from kube-apiserver
        - fromEntities:
            - kube-apiserver
          toPorts:
            - ports:
                - port: "10250"
                  protocol: TCP
                - port: "4244"
                  protocol: TCP
        # Allow access from hubble-relay to hubble-peer (running on the node)
        - fromEndpoints:
            - matchLabels:
                k8s-app: hubble-relay
          toPorts:
            - ports:
                - port: "4244"
                  protocol: TCP
                  # Allow metrics-server to scrape
        - fromEndpoints:
            - matchLabels:
                k8s-app: metrics-server
          toPorts:
            - ports:
                - port: "10250"
                  protocol: TCP
        # Allow ICMP Ping from/to anywhere.
        # - icmps:
        #     - fields:
        #         - type: 8
        #           family: IPv4
        #         - type: 128
        #           family: IPv6
        # Allow cilium tunnel/health checks from other nodes.
        - fromEntities:
            - remote-node
          toPorts:
            - ports:
                - port: "8472"
                  protocol: UDP
                - port: "4240"
                  protocol: TCP
        # Allow access to etcd and api from other nodes.
        - fromEntities:
            - remote-node
          toPorts:
            - ports:
                - port: "2379"
                  protocol: TCP
                - port: "2380"
                  protocol: TCP
                - port: "51871"
                  protocol: UDP
        # Allow access to etcd and api from unconfigured nodes
        - fromCIDR:
            - ENC[AES256_GCM,data:DB26zBMDZNad0XutfdiJIU0=,iv:oK9Ns4pJscnT5uQPKhORcK68/WpdK/6Ibx3AlfvX0FE=,tag:EDQ8VNKlxBIvVoYuXJK2Yw==,type:str]
          toPorts:
            - ports:
                - port: "2379"
                  protocol: TCP
                - port: "2380"
                  protocol: TCP
        # Allow access to ceph monintors from within the cluster
        - fromEntities:
            - cluster
          toPorts:
            - ports:
                - port: "3300"
                  protocol: TCP
                - port: "80"
                  protocol: TCP
                  # - port: "6800-7300"
                  #   protocol: TCP
                - port: "9283"
                  protocol: TCP
                  # - port: "9070"
                  #   protocol: TCP
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1ms2d7n4yhaq0mdap4cfyaq2xtfutlachqapkjfr0z2qr7ghc2ckq000jhm
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBWYnRlblV4RVRSQnJuWDBy
            TGxVS3pCclFqcU1QK28zaG5oVTdzK1cxN0dBCnY0WmdhT2ZENWI1UTJ3M1MxaGFZ
            TllFc0NpZkUwL1hxRXpkeG1SeW94MGcKLS0tIDZ0cE8xUlMzYWhocExEZnBIWG5Y
            TkVJd2dOSHZXalVOd000U3gxVllQRzAKuDZDUrwUVJNWRFlSJtA/Ty4DGqJUV6WL
            vlcvb50//2GzByxEhayJXsFYmNBU2Jop4XggtrQQfgClEZ5zTwZ/SA==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2023-10-25T22:11:13Z"
    mac: ENC[AES256_GCM,data:Tidd66VzlzGWk+vpTp29jqVYwbZhLvtp73A20yPlF+Pe7Fc9TPuWMeUgKNtmSE2qg+b7jTW76ZrsbaUinyCWrpqnhfH5Sc1ly0m/pF4tjzluFi2y/7an/M0pqqbb0wkVaEcOteNE0LUa2U6j3kmD6BC2J/RSq7Aip+npdWGtCN8=,iv:73eDH01FVZ1dOgw4bhfdNmMrasKRShWzgXOeDXWDLRc=,tag:fMuxOFLd38uuBX+9RVRGRQ==,type:str]
    pgp: []
    encrypted_regex: ^(data|stringData|fromCIDR|clusterDomain|k8sServiceHost)$
    version: 3.8.1
